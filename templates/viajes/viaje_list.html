{% extends 'base.html' %}

{% block title %}Viajes - Sistema de Gestión de Flota{% endblock %}

{% block extra_css %}
<style>
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-details {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        border: none;
    }

    .btn-passengers {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
    }

    .btn-edit-custom {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
    }

    .btn-delete-custom {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
    }

    .btn-start-trip {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
    }

    .passenger-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f3f4f6;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    .search-filter-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .search-box {
        position: relative;
    }

    .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .search-box input {
        padding-left: 40px;
    }

    .pagination {
        justify-content: center;
        margin-top: 2rem;
    }

    .pagination .page-link {
        color: #0d47a1;
        border-color: #dee2e6;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d47a1;
        border-color: #0d47a1;
    }

    .pagination .page-link:hover {
        background-color: #e3f2fd;
        color: #0d47a1;
    }

    .results-info {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-route me-2"></i>Viajes</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#searchFilters" aria-expanded="false" aria-controls="searchFilters">
            <i class="fas fa-filter me-2"></i>Búsqueda y Filtros
        </button>
        <a href="{% url 'viajes:viaje_create' %}" class="btn btn-create">
            <i class="fas fa-plus me-2"></i>Crear Nuevo Viaje
        </a>
    </div>
</div>

<!-- Sección de Búsqueda y Filtros -->
<div class="collapse {% if search or estado or bus or conductor or es_ida_vuelta or fecha_desde or fecha_hasta %}show{% endif %}" id="searchFilters">
    <div class="search-filter-section">
        <form method="get" id="filterForm">
        <div class="row mb-3">
            <div class="col-md-12">
                <label class="form-label"><i class="fas fa-search me-2"></i>Buscar</label>
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" 
                           class="form-control" 
                           name="search" 
                           value="{{ search }}" 
                           placeholder="Buscar por placa del bus, conductor, origen o destino...">
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-bus me-2"></i>Bus</label>
                <select class="form-select" name="bus">
                    <option value="">Todos los buses</option>
                    {% for bus_item in buses_disponibles %}
                        <option value="{{ bus_item.id }}" {% if bus == bus_item.id|stringformat:"s" %}selected{% endif %}>
                            {{ bus_item.placa }} - {{ bus_item.modelo }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-user-tie me-2"></i>Conductor</label>
                <select class="form-select" name="conductor">
                    <option value="">Todos los conductores</option>
                    {% for conductor_item in conductores_disponibles %}
                        <option value="{{ conductor_item.id }}" {% if conductor == conductor_item.id|stringformat:"s" %}selected{% endif %}>
                            {{ conductor_item.apellido }}, {{ conductor_item.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label"><i class="fas fa-info-circle me-2"></i>Estado</label>
                <select class="form-select" name="estado">
                    <option value="">Todos</option>
                    <option value="programado" {% if estado == 'programado' %}selected{% endif %}>Programado</option>
                    <option value="en_curso" {% if estado == 'en_curso' %}selected{% endif %}>En Curso</option>
                    <option value="finalizado" {% if estado == 'finalizado' %}selected{% endif %}>Finalizado</option>
                    <option value="cancelado" {% if estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label"><i class="fas fa-exchange-alt me-2"></i>Tipo</label>
                <select class="form-select" name="es_ida_vuelta">
                    <option value="">Todos</option>
                    <option value="si" {% if es_ida_vuelta == 'si' %}selected{% endif %}>Ida y Vuelta</option>
                    <option value="no" {% if es_ida_vuelta == 'no' %}selected{% endif %}>Solo Ida</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label"><i class="fas fa-sort me-2"></i>Ordenar</label>
                <select class="form-select" name="orden">
                    <option value="-fecha_salida" {% if orden == '-fecha_salida' %}selected{% endif %}>Fecha (Más recientes)</option>
                    <option value="fecha_salida" {% if orden == 'fecha_salida' %}selected{% endif %}>Fecha (Más antiguos)</option>
                    <option value="bus__placa" {% if orden == 'bus__placa' %}selected{% endif %}>Bus (A-Z)</option>
                    <option value="conductor__apellido" {% if orden == 'conductor__apellido' %}selected{% endif %}>Conductor (A-Z)</option>
                </select>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <label class="form-label"><i class="fas fa-calendar me-2"></i>Fecha desde</label>
                <input type="date" class="form-control" name="fecha_desde" value="{{ fecha_desde }}">
            </div>
            
            <div class="col-md-4">
                <label class="form-label"><i class="fas fa-calendar me-2"></i>Fecha hasta</label>
                <input type="date" class="form-control" name="fecha_hasta" value="{{ fecha_hasta }}">
            </div>
            
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-search me-2"></i>Buscar
                    </button>
                    <a href="{% url 'viajes:viaje_list' %}" class="btn btn-secondary">
                        <i class="fas fa-redo"></i>
                    </a>
                </div>
            </div>
        </div>
    </form>
    </div>
</div>

{% if viajes %}
    <div class="results-info">
        <i class="fas fa-info-circle me-1"></i>
        Mostrando 
        {% if page_obj.has_previous %}
            {{ page_obj.start_index }}
        {% else %}
            1
        {% endif %}
        - 
        {% if page_obj.has_next %}
            {{ page_obj.end_index }}
        {% else %}
            {{ page_obj.paginator.count }}
        {% endif %}
        de {{ page_obj.paginator.count }} viaje{{ page_obj.paginator.count|pluralize:"s" }}
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr style="background: linear-gradient(90deg, #1e40af 0%, #0d47a1 100%); color: #fff;">
                    <th>Código</th>
                    <th>Bus</th>
                    <th>Conductor</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Fecha Salida</th>
                    <th>Estado</th>
                    <th>Pasajeros</th>
                    <th style="min-width: 300px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for viaje in viajes %}
                <tr>
                    <td><span class="badge" style="background-color: #1e40af; font-size: 0.9em;">VJ-{{ viaje.pk }}</span></td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>{{ viaje.bus.placa }}</strong>
                            {% if viaje.es_ida_vuelta %}
                                <small class="text-primary mt-1">
                                    <i class="fas fa-exchange-alt" title="Viaje de ida y vuelta" style="animation: pulse 2s ease-in-out infinite;"></i>
                                </small>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ viaje.conductor.apellido }}, {{ viaje.conductor.nombre }}</td>
                    <td>{{ viaje.get_origen_display|truncatechars:25 }}</td>
                    <td>{{ viaje.get_destino_display|truncatechars:25 }}</td>
                    <td>{{ viaje.fecha_salida|date:"d/m/Y H:i" }}</td>
                    <td>
                        {% if viaje.estado == 'programado' %}
                            <span class="badge bg-info text-dark">PROGRAMADO</span>
                        {% elif viaje.estado == 'en_curso' %}
                            <span class="badge bg-warning text-dark">EN CURSO</span>
                        {% elif viaje.estado == 'completado' %}
                            <span class="badge bg-success">COMPLETADO</span>
                        {% elif viaje.estado == 'cancelado' %}
                            <span class="badge bg-danger">CANCELADO</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="passenger-badge">
                            <i class="fas fa-users"></i>
                            {{ viaje.get_pasajeros_count }}/{{ viaje.bus.capacidad_pasajeros }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if viaje.estado == 'programado' %}
                                <a href="{% url 'viajes:iniciar_viaje' viaje.pk %}" class="btn btn-start-trip" title="Iniciar Viaje">
                                    <i class="fas fa-play"></i>
                                </a>
                            {% endif %}
                            <a href="{% url 'viajes:viaje_detail' viaje.pk %}" class="btn btn-details" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'viajes:viaje_pasajeros' viaje.pk %}" class="btn btn-passengers" title="Gestionar Pasajeros">
                                <i class="fas fa-users"></i>
                            </a>
                            {% if viaje.estado == 'programado' %}
                                <a href="{% url 'viajes:viaje_update' viaje.pk %}" class="btn btn-edit-custom" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'viajes:viaje_delete' viaje.pk %}" class="btn btn-delete-custom" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    {% if page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Paginación de viajes">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if estado %}&estado={{ estado }}{% endif %}{% if bus %}&bus={{ bus }}{% endif %}{% if conductor %}&conductor={{ conductor }}{% endif %}{% if es_ida_vuelta %}&es_ida_vuelta={{ es_ida_vuelta }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" aria-label="Primera">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if estado %}&estado={{ estado }}{% endif %}{% if bus %}&bus={{ bus }}{% endif %}{% if conductor %}&conductor={{ conductor }}{% endif %}{% if es_ida_vuelta %}&es_ida_vuelta={{ es_ida_vuelta }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if estado %}&estado={{ estado }}{% endif %}{% if bus %}&bus={{ bus }}{% endif %}{% if conductor %}&conductor={{ conductor }}{% endif %}{% if es_ida_vuelta %}&es_ida_vuelta={{ es_ida_vuelta }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if estado %}&estado={{ estado }}{% endif %}{% if bus %}&bus={{ bus }}{% endif %}{% if conductor %}&conductor={{ conductor }}{% endif %}{% if es_ida_vuelta %}&es_ida_vuelta={{ es_ida_vuelta }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if estado %}&estado={{ estado }}{% endif %}{% if bus %}&bus={{ bus }}{% endif %}{% if conductor %}&conductor={{ conductor }}{% endif %}{% if es_ida_vuelta %}&es_ida_vuelta={{ es_ida_vuelta }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" aria-label="Última">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

{% else %}
    <div class="text-center py-5">
        <i class="fas fa-route fa-3x text-muted mb-3"></i>
        {% if search or estado or bus or conductor or es_ida_vuelta or fecha_desde or fecha_hasta %}
            <h4 class="text-muted">No se encontraron viajes</h4>
            <p class="text-muted">Intenta ajustar los criterios de búsqueda o filtros</p>
            <a href="{% url 'viajes:viaje_list' %}" class="btn btn-secondary">
                <i class="fas fa-redo me-2"></i>Limpiar filtros
            </a>
        {% else %}
            <h4 class="text-muted">No hay viajes registrados</h4>
            <p class="text-muted">Comienza agregando el primer viaje</p>
            <a href="{% url 'viajes:viaje_create' %}" class="btn btn-create">
                <i class="fas fa-plus me-2"></i>Crear Nuevo Viaje
            </a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}
